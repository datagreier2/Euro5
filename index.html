<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSV Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .status { margin-bottom: 12px; color: #555; }
    pre { padding: 12px; background: #f6f8fa; overflow: auto; border: 1px solid #e5e7eb; }
    table { border-collapse: collapse; margin-top: 16px; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>CSV Viewer</h1>
  <div class="status" id="status">Loading…</div>

  <h2>Raw CSV</h2>
  <pre id="raw">(waiting…)</pre>

  <h2>Table</h2>
  <div id="table-wrap"></div>

  <script>
    // --- CONFIG: adjust if needed ---
    const CSV_PATH = "./data/weekly.csv"; // relative to index.html

    // --- Minimal CSV parsing with quotes support ---
    function detectDelimiter(text) {
      // Pick the delimiter with most hits in the first non-empty line
      const first = (text.split(/\r?\n/).find(l => l.trim().length) || "");
      const counts = { ",": (first.match(/,/g) || []).length,
                       ";": (first.match(/;/g) || []).length,
                       "\t": (first.match(/\t/g) || []).length };
      return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ",";
    }

    function parseCSV(text) {
      // Strip BOM if present
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const delim = detectDelimiter(text);
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;

      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            const n = text[i+1];
            if (n === '"') { field += '"'; i++; } else { inQuotes = false; }
          } else {
            field += c;
          }
        } else {
          if (c === '"') inQuotes = true;
          else if (c === delim) { row.push(field); field = ""; }
          else if (c === "\n" || c === "\r") {
            if (c === "\r" && text[i+1] === "\n") i++;
            row.push(field); field = "";
            if (row.length && row.some(x => x !== "")) rows.push(row);
            row = [];
          } else {
            field += c;
          }
        }
        i++;
      }
      if (field.length || row.length) { row.push(field); rows.push(row); }

      // Trim cells
      return rows.map(r => r.map(x => (x ?? "").trim()));
    }

    function renderTable(rows) {
      const wrap = document.getElementById("table-wrap");
      wrap.innerHTML = "";
      if (!rows.length) { wrap.textContent = "No rows."; return; }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");

      // header row (first row)
      const htr = document.createElement("tr");
      rows[0].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h || "";
        htr.appendChild(th);
      });
      thead.appendChild(htr);

      // data rows
      for (let r = 1; r < rows.length; r++) {
        const tr = document.createElement("tr");
        rows[r].forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell || "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }

      table.appendChild(thead);
      table.appendChild(tbody);
      wrap.appendChild(table);
    }

    async function main() {
      const status = document.getElementById("status");
      const raw = document.getElementById("raw");
      try {
        status.textContent = `Fetching ${CSV_PATH} …`;
        const res = await fetch(`${CSV_PATH}?v=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} for ${CSV_PATH}`);
        const text = await res.text();
        raw.textContent = text;
        const rows = parseCSV(text);
        renderTable(rows);
        status.textContent = `Loaded ${rows.length - 1} rows from ${CSV_PATH}`;
      } catch (err) {
        status.textContent = `Error: ${err.message}`;
        raw.textContent = "(failed to load)";
        document.getElementById("table-wrap").textContent =
          "Could not load CSV. Open your CSV directly to verify it’s served: " + CSV_PATH;
        console.error(err);
      }
    }

    main();
  </script>
</body>
</html>
