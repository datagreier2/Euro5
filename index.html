<!doctype html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EURO5 News</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <nav class="topnav">
    <div class="nav-logo">
      <a href="/">
        <img src="./Euro5_beta_logo.svg" alt="Euro5 logo" style="height:32px;width:auto;vertical-align:middle;">
      </a>
    </div>
    <div class="nav-links">
      <a href="om.html">om</a>
      <a href="hvorfor.html">hvorfor</a>
      <a href="dev.html">dev</a>
    </div>
  </nav>

  <div class="wrap">
    <div id="top-content">
      <div style="display:flex;flex-direction:column;align-items:flex-start;gap:8px;margin-bottom:18px;">
        
        <h1 style="margin:0;">Ukentlig nyhetsoppdatering</h1>
        <div style="margin-top:10px; color:#e7e9ee; font-size:1.08rem; max-width:600px;">
          EURO5 samler ukens nyheter fra uken, hver søndag.
        </div>
        <div style="margin-top:8px; color:#b0b8c1; font-size:1rem; max-width:600px;">
          Nyhetene blir hentet fra europeiske kilder på engelsk, svensk, norsk og dansk. Siden er under kontinuerlig utvikling og er i en testfase.
        </div>
      </div>
  <div style="width:100%; display:flex; justify-content:center; margin-bottom:40px;">
        <button id="hideTopBtn" style="margin-bottom:0; font-size:0.95rem; background:#D8C475; color:#404040; border:none; border-radius:14px; padding:4px 16px; cursor:pointer;">Skjul</button>
      </div>
    </div>

    <!-- Status div removed -->
    <div id="pills" class="pills"></div>
    <div id="app"></div>
    <div id="empty" class="empty" hidden>No items found.</div>
  </div>

  <script>
  // Hide/Show top content logic
  document.addEventListener('DOMContentLoaded', function() {
    const topContent = document.getElementById('top-content');
    const hideBtn = document.getElementById('hideTopBtn');
    hideBtn.addEventListener('click', function() {
      topContent.style.display = 'none';
    });
  });
  let allGroups = new Map();
  let activeCategory = null;
    const CSV_PATH = "./data/weekly.csv"; // adjust if needed

    // --- CSV utils (delimiter autodetect + BOM handling + quoted fields) ---
    function detectDelimiter(text) {
      const first = (text.split(/\r?\n/).find(l => l.trim().length) || "");
      const counts = { ",": (first.match(/,/g) || []).length,
                       ";": (first.match(/;/g) || []).length,
                       "\t": (first.match(/\t/g) || []).length };
      return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ",";
    }
    function parseCSV(text) {
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const d = detectDelimiter(text);
      const rows = []; let i=0, field="", row=[], q=false;
      while (i < text.length) {
        const c = text[i];
        if (q) {
          if (c === '"') { const n = text[i+1]; if (n === '"'){ field+='"'; i++; } else { q=false; } }
          else field += c;
        } else {
          if (c === '"') q = true;
          else if (c === d) { row.push(field.trim()); field=""; }
          else if (c === "\n" || c === "\r") {
            if (c === "\r" && text[i+1] === "\n") i++;
            row.push(field.trim()); field="";
            if (row.some(x=>x!=="")) rows.push(row); row=[];
          } else field += c;
        }
        i++;
      }
      if (field.length || row.length) { row.push(field.trim()); rows.push(row); }
      return rows;
    }

    function keyLookup(obj, candidates) {
      const keys = Object.keys(obj);
      for (const name of candidates) {
        const k = keys.find(x => x.toLowerCase() === name.toLowerCase());
        if (k) return k;
      }
      return null;
    }

    function groupBySubgroup(records) {
      if (!records.length) return new Map();
      // Heuristics for headers
      const probe = records[0];
      const H = {
        category: keyLookup(probe, ["category", "kategori"]),
        subgroup: keyLookup(probe, ["subgroup", "group", "undergruppe"]),
        title:    keyLookup(probe, ["title","headline","tittel","overskrift"]),
        link:     keyLookup(probe, ["link","url","href"]),
        summary:  keyLookup(probe, ["summary","description","ingress","lede"])
      };
      if (!H.category) console.warn("No 'category' column detected. Available columns:", Object.keys(probe));

      const out = new Map(); // category -> items[]
      for (const r of records) {
        const cat = (H.category ? r[H.category] : "Other") || "Other";
        const item = {
          title: (H.title && r[H.title]) || "(untitled)",
          link:  (H.link  && r[H.link])  || "",
          summary: (H.summary && r[H.summary]) || "",
          subgroup: (H.subgroup && r[H.subgroup]) || "",
          source_url: r["source_url"] || ""
        };
        if (!out.has(cat)) out.set(cat, []);
        out.get(cat).push(item);
      }
      return out;
    }

    function renderGroups(groups) {
      const app = document.getElementById("app");
      const empty = document.getElementById("empty");
      app.innerHTML = "";

      // Filter groups if a pill is active
      let filteredGroups = groups;
      if (activeCategory && groups.has(activeCategory)) {
        filteredGroups = new Map([[activeCategory, groups.get(activeCategory)]]);
      }

      if (!filteredGroups.size) { empty.hidden = false; return; }
      empty.hidden = true;

      // Shuffle all cards if 'All' view
      if (!activeCategory) {
        // Flatten all items into one array
        let allItems = [];
        for (const items of filteredGroups.values()) {
          allItems = allItems.concat(items);
        }
        // Shuffle
        for (let i = allItems.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [allItems[i], allItems[j]] = [allItems[j], allItems[i]];
        }
        // Render as a single section
        const section = document.createElement("section");
        const h2 = document.createElement("h2");
        h2.innerHTML = `<span>Alle kategorier</span><span class="count">${allItems.length}</span>`;
        section.appendChild(h2);
        const ul = document.createElement("ul");
        for (const it of allItems) {
          const li = document.createElement("li");
          if (it.link) {
            const a = document.createElement("a");
            a.href = it.link; a.target = "_blank"; a.rel = "noopener noreferrer";
            a.textContent = it.title;
            li.appendChild(a);
          } else {
            const strong = document.createElement("strong");
            strong.textContent = it.title;
            li.appendChild(strong);
          }
          // Show domain
          let domain = "";
          try {
            let url = it.link || it.source_url || "";
            if (url) {
              domain = new URL(url, window.location.href).hostname.replace(/^www\./, "");
            }
          } catch(e) {}
          if (domain) {
            const d = document.createElement("div");
            d.className = "domain-label";
            d.textContent = domain.toUpperCase();
            li.appendChild(d);
          }
          if (it.summary) {
            const p = document.createElement("div");
            p.className = "summary";
            let capped = it.summary;
            if (capped.length > 100) capped = capped.slice(0, 97) + "...";
            p.textContent = capped;
            li.appendChild(p);
          }
          ul.appendChild(li);
        }
        section.appendChild(ul);
        app.appendChild(section);
        return;
      }

      // Otherwise, show grouped and sorted
      const entries = [...filteredGroups.entries()].sort((a,b) => a[0].localeCompare(b[0]));
      for (const [name, items] of entries) {
        const section = document.createElement("section");
        // Show 'Økonomi' instead of 'Næringsliv og Nasjonaløkonomi' (case-insensitive)
        const displayName = (/^næringsliv og nasjonaløkonomi$/i.test(name)) ? "Økonomi" : name;
        const h2 = document.createElement("h2");
        h2.innerHTML = `<span>${displayName}</span><span class="count">${items.length}</span>`;
        section.appendChild(h2);
        const ul = document.createElement("ul");
        for (const it of items) {
          const li = document.createElement("li");
          if (it.link) {
            const a = document.createElement("a");
            a.href = it.link; a.target = "_blank"; a.rel = "noopener noreferrer";
            a.textContent = it.title;
            li.appendChild(a);
          } else {
            const strong = document.createElement("strong");
            strong.textContent = it.title;
            li.appendChild(strong);
          }
          // Show domain
          let domain = "";
          try {
            let url = it.link || it.source_url || "";
            if (url) {
              domain = new URL(url, window.location.href).hostname.replace(/^www\./, "");
            }
          } catch(e) {}
          if (domain) {
            const d = document.createElement("div");
            d.className = "domain-label";
            d.textContent = domain.toUpperCase();
            li.appendChild(d);
          }
          if (it.summary) {
            const p = document.createElement("div");
            p.className = "summary";
            let capped = it.summary;
            if (capped.length > 100) capped = capped.slice(0, 97) + "...";
            p.textContent = capped;
            li.appendChild(p);
          }
          ul.appendChild(li);
        }
        section.appendChild(ul);
        app.appendChild(section);
      }
    }

    function renderPills(groups) {
      const pills = document.getElementById("pills");
      pills.innerHTML = "";
      const categories = [...groups.keys()].sort((a,b) => a.localeCompare(b));
      if (categories.length <= 1) { pills.style.display = "none"; return; }
      pills.style.display = "flex";
      // 'All' pill
      const allBtn = document.createElement("button");
      allBtn.className = "pill" + (activeCategory === null ? " active" : "");
  allBtn.textContent = "Alle";
      allBtn.onclick = () => {
        activeCategory = null;
        renderPills(allGroups);
        renderGroups(allGroups);
      };
      pills.appendChild(allBtn);
      // Category pills
      for (const cat of categories) {
        const btn = document.createElement("button");
        btn.className = "pill" + (activeCategory === cat ? " active" : "");
  btn.textContent = (/^næringsliv og nasjonaløkonomi$/i.test(cat)) ? "Økonomi" : cat;
        btn.onclick = () => {
          activeCategory = cat;
          renderPills(allGroups);
          renderGroups(allGroups);
        };
        pills.appendChild(btn);
      }
    }

    async function main() {
        try {
          // Status message removed
  const res = await fetch(`${CSV_PATH}?v=${Date.now()}`, { cache: "no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status} for ${CSV_PATH}`);
  // Use TextDecoder to ensure UTF-8 decoding
  const buf = await res.arrayBuffer();
  const text = new TextDecoder('utf-8').decode(buf);

        // parse
        const rows = parseCSV(text);
        if (!rows.length) throw new Error("CSV is empty");
        const headers = rows[0].map(h => (h || "").replace(/^\ufeff/, "").trim());
        const records = rows.slice(1).map(r => {
          const o = {};
          headers.forEach((h, i) => o[h] = r[i] ?? "");
          return o;
        });

  const groups = groupBySubgroup(records);
  allGroups = groups;
  renderPills(groups);
  renderGroups(groups);
      } catch (err) {
        console.error(err);
          // Status message removed
        document.getElementById("empty").hidden = false;
      }
    }
    main();
  </script>
</body>
</html>
