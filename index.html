<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>News (Grouped by Subgroup)</title>
  <style>
    .domain-label {
      font-size: 0.78em;
      font-weight: 600;
      letter-spacing: 0.04em;
      color: var(--muted);
      margin-top: 2px;
      margin-bottom: 2px;
      text-transform: uppercase;
    }
    .pills {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
    }
    .pill {
      background: var(--border);
      color: var(--fg);
      border: none;
      border-radius: 20px;
      padding: 7px 18px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .pill.active {
      background: #75D8D1;
      color: #404040;
    }
    :root { --fg:#e7e9ee; --muted:#9aa3b2; --border:#242938; --accent:#3b82f6; --bg:#404040; }
    @media (prefers-color-scheme: dark) {
      :root { --fg:#e7e9ee; --muted:#9aa3b2; --border:#242938; --accent:#3b82f6; --bg:#404040; }
    }
    *{box-sizing:border-box}
    body{margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--fg)}
    .wrap{max-width:900px; margin:0 auto; padding:24px}
    h1{margin:0 0 10px 0; font-size:clamp(1.25rem,1rem + 1.5vw,2rem)}
    .status{color:var(--muted); margin-bottom:8px}
    section{margin:22px 0}
    section>h2{
      margin:0 0 10px 0; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:linear-gradient(180deg,rgba(0,0,0,.04),transparent); font-size:1rem;
      display:flex; align-items:center; gap:10px; justify-content:space-between
    }
    .count{color:var(--muted); font-size:.9rem}
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      max-width: 100%;
    }
    li {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 14px;
      background: linear-gradient(180deg,rgba(0,0,0,.02),transparent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
      min-height: 120px;
    }
    @media (min-width: 900px) {
      ul {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  a{color:#75D8D1; text-decoration:none; font-weight:600}
  a:hover{color:#75D8D1; text-decoration:underline}
  .summary{color:#FFFFFF; margin-top:4px}
    .empty{margin-top:16px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
  <h1>EURO5 News</h1>
    <!-- Status div removed -->
  <div id="pills" class="pills"></div>
  <div id="app"></div>
  <div id="empty" class="empty" hidden>No items found.</div>
  </div>

  <script>
  let allGroups = new Map();
  let activeCategory = null;
    const CSV_PATH = "./data/weekly.csv"; // adjust if needed

    // --- CSV utils (delimiter autodetect + BOM handling + quoted fields) ---
    function detectDelimiter(text) {
      const first = (text.split(/\r?\n/).find(l => l.trim().length) || "");
      const counts = { ",": (first.match(/,/g) || []).length,
                       ";": (first.match(/;/g) || []).length,
                       "\t": (first.match(/\t/g) || []).length };
      return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ",";
    }
    function parseCSV(text) {
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const d = detectDelimiter(text);
      const rows = []; let i=0, field="", row=[], q=false;
      while (i < text.length) {
        const c = text[i];
        if (q) {
          if (c === '"') { const n = text[i+1]; if (n === '"'){ field+='"'; i++; } else { q=false; } }
          else field += c;
        } else {
          if (c === '"') q = true;
          else if (c === d) { row.push(field.trim()); field=""; }
          else if (c === "\n" || c === "\r") {
            if (c === "\r" && text[i+1] === "\n") i++;
            row.push(field.trim()); field="";
            if (row.some(x=>x!=="")) rows.push(row); row=[];
          } else field += c;
        }
        i++;
      }
      if (field.length || row.length) { row.push(field.trim()); rows.push(row); }
      return rows;
    }

    function keyLookup(obj, candidates) {
      const keys = Object.keys(obj);
      for (const name of candidates) {
        const k = keys.find(x => x.toLowerCase() === name.toLowerCase());
        if (k) return k;
      }
      return null;
    }

    function groupBySubgroup(records) {
      if (!records.length) return new Map();
      // Heuristics for headers
      const probe = records[0];
      const H = {
        category: keyLookup(probe, ["category", "kategori"]),
        subgroup: keyLookup(probe, ["subgroup", "group", "undergruppe"]),
        title:    keyLookup(probe, ["title","headline","tittel","overskrift"]),
        link:     keyLookup(probe, ["link","url","href"]),
        summary:  keyLookup(probe, ["summary","description","ingress","lede"])
      };
      if (!H.category) console.warn("No 'category' column detected. Available columns:", Object.keys(probe));

      const out = new Map(); // category -> items[]
      for (const r of records) {
        const cat = (H.category ? r[H.category] : "Other") || "Other";
        const item = {
          title: (H.title && r[H.title]) || "(untitled)",
          link:  (H.link  && r[H.link])  || "",
          summary: (H.summary && r[H.summary]) || "",
          subgroup: (H.subgroup && r[H.subgroup]) || "",
          source_url: r["source_url"] || ""
        };
        if (!out.has(cat)) out.set(cat, []);
        out.get(cat).push(item);
      }
      return out;
    }

    function renderGroups(groups) {
      const app = document.getElementById("app");
      const empty = document.getElementById("empty");
      app.innerHTML = "";

      // Filter groups if a pill is active
      let filteredGroups = groups;
      if (activeCategory && groups.has(activeCategory)) {
        filteredGroups = new Map([[activeCategory, groups.get(activeCategory)]]);
      }

      if (!filteredGroups.size) { empty.hidden = false; return; }
      empty.hidden = true;

      // sort subgroups by name
      const entries = [...filteredGroups.entries()].sort((a,b) => a[0].localeCompare(b[0]));
      for (const [name, items] of entries) {
        const section = document.createElement("section");
  // Show 'Økonomi' instead of 'Næringsliv og Nasjonaløkonomi' (case-insensitive)
  const displayName = (/^næringsliv og nasjonaløkonomi$/i.test(name)) ? "Økonomi" : name;
        const h2 = document.createElement("h2");
        h2.innerHTML = `<span>${displayName}</span><span class="count">${items.length}</span>`;
        section.appendChild(h2);
        const ul = document.createElement("ul");
        for (const it of items) {
          const li = document.createElement("li");
          if (it.link) {
            const a = document.createElement("a");
            a.href = it.link; a.target = "_blank"; a.rel = "noopener noreferrer";
            a.textContent = it.title;
            li.appendChild(a);
          } else {
            const strong = document.createElement("strong");
            strong.textContent = it.title;
            li.appendChild(strong);
          }
          // Show domain
          let domain = "";
          try {
            let url = it.link || it.source_url || "";
            if (url) {
              domain = new URL(url, window.location.href).hostname.replace(/^www\./, "");
            }
          } catch(e) {}
          if (domain) {
            const d = document.createElement("div");
            d.className = "domain-label";
            d.textContent = domain.toUpperCase();
            li.appendChild(d);
          }
          if (it.summary) {
            const p = document.createElement("div");
            p.className = "summary";
            let capped = it.summary;
            if (capped.length > 100) capped = capped.slice(0, 97) + "...";
            p.textContent = capped;
            li.appendChild(p);
          }
          ul.appendChild(li);
        }
        section.appendChild(ul);
        app.appendChild(section);
      }
    }

    function renderPills(groups) {
      const pills = document.getElementById("pills");
      pills.innerHTML = "";
      const categories = [...groups.keys()].sort((a,b) => a.localeCompare(b));
      if (categories.length <= 1) { pills.style.display = "none"; return; }
      pills.style.display = "flex";
      // 'All' pill
      const allBtn = document.createElement("button");
      allBtn.className = "pill" + (activeCategory === null ? " active" : "");
      allBtn.textContent = "All";
      allBtn.onclick = () => {
        activeCategory = null;
        renderPills(allGroups);
        renderGroups(allGroups);
      };
      pills.appendChild(allBtn);
      // Category pills
      for (const cat of categories) {
        const btn = document.createElement("button");
        btn.className = "pill" + (activeCategory === cat ? " active" : "");
  btn.textContent = (/^næringsliv og nasjonaløkonomi$/i.test(cat)) ? "Økonomi" : cat;
        btn.onclick = () => {
          activeCategory = cat;
          renderPills(allGroups);
          renderGroups(allGroups);
        };
        pills.appendChild(btn);
      }
    }

    async function main() {
        try {
          // Status message removed
        const res = await fetch(`${CSV_PATH}?v=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} for ${CSV_PATH}`);
        const text = await res.text();

        // parse
        const rows = parseCSV(text);
        if (!rows.length) throw new Error("CSV is empty");
        const headers = rows[0].map(h => (h || "").replace(/^\ufeff/, "").trim());
        const records = rows.slice(1).map(r => {
          const o = {};
          headers.forEach((h, i) => o[h] = r[i] ?? "");
          return o;
        });

  const groups = groupBySubgroup(records);
  allGroups = groups;
  renderPills(groups);
  renderGroups(groups);
      } catch (err) {
        console.error(err);
          // Status message removed
        document.getElementById("empty").hidden = false;
      }
    }
    main();
  </script>
</body>
</html>
